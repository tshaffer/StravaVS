<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>StravaStatsByTed</title>

    <style>

      html { height: 100% } 
      body { height: 100%; margin: 0; padding: 0; background-color: #f2f2f2 }

        #map-canvas {
            position: absolute;
            top: 77px;
            width: 1800px;
            height: 400px;
            display: none;
        }

        #mapBuilder-canvas {
            position: absolute;
            top: 0px;
            width: 1800px;
            height: 800px;
            display: none;
        }

        #elevationChart {
            position: absolute;
            top: 500px;
            width: 1800px;
            height: 200px;
            display: none;
        }

        #DetailedActivity {
            position: absolute;
            top: 700px;
            width: 1800px;
            height: 800px;
        }

        table,th,td
        {
            border:1px solid black;
            border-collapse:collapse;
        }
        th,td
        {
            padding:5px;
        }

        /*table.hoverTable tr:hover td {
            background-color: #FEFEFE;
        }
        #DetailedActivity tr:hover {
          background-color: lightyellow;
        }*/

        .fastestTime {
            color: red;
        }

        .detailsActivity {
            display: none;
        }

        .detailsActivity th {
            background-color: #c8c8c8;
            border: 0px solid black;
            border-collapse:collapse;
        }

        .detailsActivityTable {
            border: 0px solid black;
            border-collapse:collapse;
        }

        .detailsActivityTable tr {
            border-bottom: 1px solid lightgray;
            /*border-collapse:collapse;*/
        }

        .detailsActivityTable td {
            text-align: center;
            background-color: #fcfcfc;
            border: 0px solid black;
            border-collapse:collapse;
        }

        #RideSummary {
            position: absolute;
            top: 0px;
            width: 1800px;
            height: 55px;
            display: none;
            background-color: #f2f2f2;
        }

        .summaryTable {
            border: 0px solid black;
            border-collapse:collapse;
            width:800px;
        }

        .summaryTable td {
            border: 0px solid black;
            border-collapse:collapse;
        }

        .summaryDataRow {
            font-weight: bold;
            font-size:150%;
        }

        .summaryDataRow td {
            padding-top:4px;
            padding-right:10px;
            padding-bottom:4px;
            padding-left:10px;
        }

        .summaryLabels {
            font-size:80%;
            color: #a0a0a0;
        }

        .summaryLabels td {
            padding-top:4px;
            padding-right:10px;
            padding-bottom:0px;
            padding-left:10px;
        }

        #SegmentSummary {
            display: none;
            /*position: absolute;
            top: 0px;
            width: 1800px;
            height: 55px;*/
            background-color: #f2f2f2;
        }

        .hidden {
            display:none;
        }

    </style>

    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="config.js"></script>
    <script src="https://www.google.com/jsapi"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=drawing,geometry&key=AIzaSyAQMkpxb9BOWSzHYvNhJz9LZuZqGp0toF4"></script>

    <script>

        // load visualization package for later use
        google.load("visualization", "1", { packages: ["corechart"] });

        $(document).ready(function () {

// GLOBAL VARIABLES
            var currentStravaState;

            var athleteId;
            var athleteName;

            var currentActivities;
            var selectedDetailedEfforts;

            var selectedActivity;

            var athletes = [];
            var segmentEffortsByAthlete = [];

            var activitiesTableColumnOrders = {};
            var effortsTableColumnOrders = {};
            var currentSortColumn;

            var segmentEffortsData = [];

            var effortsNameHidden;

            var activitiesToCompare = [];

            var activityMap;
            var activityPath;
            var ridePathDecoded;
            var elevations;
            var mapMarker;

            var segmentEffortOccurrenceCount = {}
// ACTIVITIES

            function buildActivityRow(activity) {

                //console.log("buildActivityRow invoked, activity is ");
                //console.log(activity);

                // activityName
                var activityName = activity.name;

                // athleteId
                var athleteId = activity.athleteId;

                // id
                var activityId = activity.activityId;

                // ride date
                //d = new Date(activity.start_date_local);
                var d = new Date(activity.startDateTime);
                var date = d.toLocaleString();

                // distance
                var miles = activity.distance;

                // riding time
                var movingTime = getMovingTime(activity.movingTime);

                // elevation gain
                var elevationGain = activity.totalElevationGain;

                // average speed (meters per second)
                var mph = activity.averageSpeed;

                var calories = activity.calories;

                //rowToAdd = '<tr><td>' + date + '</td><td>' + activity.name + '</td><td>' + movingTime + '</td><td>' + miles.toFixed(0) + ' miles</td><td>' + elevationGain + ' ft</td><td>' + mph.toFixed(1) + ' mph</td><td>' + calories + '</td><td>' + "<input id='" + activityId + "' type='submit' value='Show details'/>" + '</td></tr>';
                var rowToAdd = "<tr id='tr" + activityId + "'><td><input type='checkbox'/></td><td>" + date + '</td><td>' + activity.name + '</td><td>' + movingTime + '</td><td>' + miles.toFixed(0) + ' miles</td><td>' + elevationGain + ' ft</td><td>' + mph.toFixed(1) + ' mph</td><td>' + calories + '</td><td>' + "<input id='" + activityId + "' type='submit' value='Show details'/>" + '</td><td>' + "<input id='" + activityId + "-mapBuilder' type='submit' value='Map builder'/>" + '</td></tr>';
                $('#activitiesTable').append(rowToAdd);

                // add button handlers for this particular activity
                var btnId = "#" + activityId;
                $(btnId).click({ activityId: activityId, athleteId: athleteId, activityName: activityName, activity: activity }, showDetailsEventHandler);

                btnId = "#" + activityId + "-mapBuilder";
                $(btnId).click({ activityId: activityId, athleteId: athleteId, activityName: activityName, activity: activity }, mapBuilderInvokedEventHandler);
            }

            function buildActivitiesTable(activities) {

                $("#activitiesTable input").unbind("click");

                $.each(activities, function (index, activityElement) {
                    buildActivityRow(activityElement);
                });
            }

            function sortActivitiesByDate(activities) {
                $.each(activities, function (index, activity) {
                    activity.dateTime = new Date(activity.startDateTime);
                });

                activities.sort(function (a, b) {
                    if (a.dateTime < b.dateTime)
                        return 1;
                    if (a.dateTime > b.dateTime)
                        return -1
                    return 0;
                });
            }

            function showActivitiesTable() {
                $('#SegmentEffortsSection').hide();
                $('#DetailedActivity').hide();
                $('#RideSummary').hide();
                $('#ComparedActivities').hide();
                $('#SegmentSummary').hide();
                $('#elevationChart').hide();
                $('#map-canvas').hide();
                $('#SummaryActivities').show();
            }

            // retrieves the activities, one at a time
            function retrieveActivity(activityIds, activityId) {

                //console.log("retrieveActivity invoked, activityId: " + activityId);

                $.ajax({
                    url: 'http://' + hostName + ':8080/activityEfforts',
                    data: { "activityId": activityId, "athleteId": athleteId },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("retrieveActivity success");
                    //console.log(textStatus);
                    //console.log(data);

                    // do something with this activity (push it?)
                    activitiesToCompare.push(data);

                    if (activityIds.length == 0) {
                        buildComparisonData();
                        return;
                    }

                    activityId = activityIds.shift();
                    retrieveActivity(activityIds, activityId);
                });
            }

            function retrieveBestEfforts(segmentIds, rowLabels) {

                $.ajax({
                    url: 'http://' + hostName + ':8080/bestTimes',
                    data: { "segmentIds": segmentIds },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("retrieveBestTimes success");
                    //console.log(textStatus);
                    //console.log(data);

                    buildComparisonData2(segmentIds, rowLabels, data);
                });

            }

            function buildComparisonData() {

                masterActivity = activitiesToCompare[0];

                // the labels for each row are the names of each of the segments in the master activity
                var rowLabels = [];
                var masterSegmentIds = [];
                $.each(masterActivity.detailedEfforts, function (index, detailedEffort) {
                    rowLabels.push(detailedEffort.segmentName);
                    masterSegmentIds.push(detailedEffort.segmentId);
                });

                retrieveBestEfforts(masterSegmentIds, rowLabels);
            }

            function buildComparisonData2(masterSegmentIds, rowLabels, bestTimesBySegment)
            {
                //console.log("buildComparisonData2: bestTimesBySegment");
                //console.log(bestTimesBySegment);

                var columns = [];

                // for each activity
                //      create column
                //      for each segment
                //          is this segment in the master segment list?
                //              if yes, get the segment moving time; if not, leave blank
                //          push onto column

                $.each(activitiesToCompare, function (activityIndex, activity) {
                    var column = [];
                    $.each(masterSegmentIds, function (masterSegmentIdIndex, masterSegmentId) {
                        var movingTime = "";
                        $.each(activity.detailedEfforts, function (segmentIndex, detailedEffort) {
                            thisSegmentId = detailedEffort.segmentId;
                            if (thisSegmentId == masterSegmentId) {
                                movingTime = detailedEffort.movingTime;
                                return false;
                            }
                        });
                        column.push(movingTime);
                    });
                    columns.push(column);
                });

                //console.log(columns);
                $("#comparedActivitiesTable").empty();

                // for each segment in masterSegments
                // output rowLabel
                var rowToAdd = "<tr><th></th>";
                $.each(activitiesToCompare, function (activityIndex, activity) {
                    // bogus selection of date
                    var d = new Date(activity.detailedEfforts[0].startDateTime);
                    var date = d.toDateString();
                    rowToAdd += "<th>" + date + "</th>";
                });
                rowToAdd += "<th>Best Time</th></tr>";
                $('#comparedActivitiesTable').append(rowToAdd);

                // for each item in column, output entry
                $.each(masterSegmentIds, function (masterSegmentIdIndex, masterSegmentId) {

                    // track best times within a row - then highlight it(them)
                    var fastestTime = 99999;
                    var columnsOfFastestTime = [];

                    // best time ever for this segment
                    bestTime = bestTimesBySegment[masterSegmentId];
                    //console.log("bestTime: " + bestTime);

                    var rowToAdd = "<tr><td>" + rowLabels[masterSegmentIdIndex] + "</td>";
                    $.each(columns, function (columnIndex, column) {
                        var thisTime = column[masterSegmentIdIndex];
                        var tdStr = "<td>";
                        if (typeof thisTime == "number") {
                            timeAsStr = getMovingTime(thisTime);

                            // <= fastestTime; if yes, note it somehow
                            if (thisTime < fastestTime) {
                                columnsOfFastestTime = [];
                            }
                            if (thisTime <= fastestTime) {
                                fastestTime = thisTime;
                                columnsOfFastestTime.push(columnIndex);
                            }
                            if (thisTime <= bestTime) {
                                tdStr = "<td class='fastestTimeEver'>";
                                timeAsStr += "*";
                            }
                        }
                        else {
                            timeAsStr = "";
                        }
                        rowToAdd += tdStr + timeAsStr + "</td>";
                    });

                    // add best time (ever) for this effort
                    bestTimeAsStr = getMovingTime(bestTime);
                    rowToAdd += "<td>" + bestTimeAsStr + "</td>";

                    rowToAdd += "</tr>";
                    $('#comparedActivitiesTable').append(rowToAdd);

                    // highlight the entry in the columns with the fastest times.
                    $.each(columnsOfFastestTime, function (index, columnOfFastestTime) {
                        var columnOfFastestTimeChildIndex = columnOfFastestTime + 2;
                        //$("#comparedActivitiesTable tr:last td:nth-child(" + columnOfFastestTimeChildIndex + ")").css("color", "red");
                        $("#comparedActivitiesTable tr:last td:nth-child(" + columnOfFastestTimeChildIndex + ")").addClass("fastestTime");
                    });
                });

                $('#SummaryActivities').hide();
                $('#ComparedActivities').show();    // show the friends segment efforts table
            }

            function compareActivities(activityIds) {
                //console.log("compareActivities invoked, activityIds:");
                //console.log(activityIds);

                // retrieve all of the selected activities first
                var activityId = activityIds.shift();
                activitiesToCompare = [];
                retrieveActivity(activityIds, activityId);
                return;



                var masterActivityId = activityIds[0];
                var masterActivityName = getActivityName(masterActivityId);

                // retrieve master activity
                $.ajax({
                    url: 'http://' + hostName + ':8080/activityEfforts',
                    data: { "activityId": masterActivityId, "athleteId": athleteId, "activityName": masterActivityName },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("success");
                    //console.log(textStatus);
                    //console.log(data);

                    var masterActivity = data;

                    // the labels for each row are the names of each of the segments in the master activity
                    var rowLabels = [];
                    var masterSegmentIds = [];
                    $.each(masterActivity.detailedEfforts, function (index, detailedEffort) {
                        rowLabels.push(detailedEffort.segmentName);
                        masterSegmentIds.push(detailedEffort.segmentId);
                    });

                    //console.log("rowLabels: ");
                    //console.log(rowLabels);

                    //console.log("masterSegmentIds:");
                    //console.log(masterSegmentIds);

                });

                // currentActivities - contains is the array of activities for the authenticated athlete. each one is an object that includes an activityId member.
                // there is nothing in the object that references the list of associated segment efforts
                // however, there should be an object somewhere the associates activityId's with segments, efforts. This would get accessed when the user presses Details.
                // something to keep in mind - there may be data required that is not yet loaded - code that loads it would be associated with the Show Details button handler.

            }

// GOOGLE MAPS

            function decodeLevels(encodedLevelsString) {
                var decodedLevels = [];

                for (var i = 0; i < encodedLevelsString.length; ++i) {
                    var level = encodedLevelsString.charCodeAt(i) - 63;
                    decodedLevels.push(level);
                }
                return decodedLevels;
            }

            function initializeMap(activity, mapId) {
                //console.log("initializeMap: activity is");
                //console.log(activity);

                var myLatlng = new google.maps.LatLng(activity.startPointLatitude, activity.startPointLongitude);
                var myOptions = {
                    zoom: 14,
                    center: myLatlng,
                    //mapTypeId: google.maps.MapTypeId.TERRAIN
                    mapTypeId: google.maps.MapTypeId.ROADMAP
            }

                var createNewMap;
                if (activityMap == undefined) {
                    createNewMap = true;
                }
                else {
                    createNewMap = false;
                }

                if (createNewMap) {
                    activityMap = new google.maps.Map(document.getElementById(mapId), myOptions);
                }
                else {
                    activityMap.setZoom(14);
                    activityMap.setCenter(myLatlng);
                    if (activityPath != undefined) {
                        activityPath.setMap(null);
                    }
                }

                var pathToDecode = activity.mapPolyline;
                ridePathDecoded = google.maps.geometry.encoding.decodePath(pathToDecode);
                var decodedLevels = decodeLevels("BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");

                var existingBounds = activityMap.getBounds();

                var bounds = new google.maps.LatLngBounds();
                $.each(ridePathDecoded, function (index, location) {
                    bounds.extend(location);
                });

                if (createNewMap) {
                    activityMap.fitBounds(bounds);
                }
                else {
                    setTimeout(function () { activityMap.fitBounds(bounds); }, 1);
                }
                activityPath = new google.maps.Polyline({
                    path: ridePathDecoded,
                    levels: decodedLevels,
                    strokeColor: "#FF0000",
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: activityMap
                });
            }

            function buildElevationGraphFromGoogleData(selectedActivity) {

                var elevationLocation;

                var elevator = new google.maps.ElevationService();

                // Create a PathElevationRequest object using the path for the activity.
                // Ask for 256 samples along that path.
                var pathRequest = {
                    'path': ridePathDecoded,
                    'samples': 256
                };

                // Initiate the path request.
                elevator.getElevationAlongPath(pathRequest, elevationCallback);
            }

            function elevationCallback(results, status) {
                if (status != google.maps.ElevationStatus.OK) {
                    return;
                }
                elevations = results;

                //  results[0].elevation: elevation at a point (in meters)
                //  results[0].resolution: distance between two points (in meters). the same for all points?
                //  results[0].location: lat, lng object representing the point

                drawChartFromGoogleData();
            }

            function drawChartFromGoogleData() {

                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn('number', 'Distance');
                dataTable.addColumn('number', 'Elevation');
                dataTable.addColumn({ type: 'string', role: 'tooltip', 'p': { 'html': true } });

                var row = [];

                var distanceFromStart = 0;
                var lastElevation;

                var mapDistanceToLocation = {};

                var distanceFromLastPoint = -1;
                var elevationAtLastPoint = -1;

                $.each(elevations, function (index, elevation) {

                    if (index > 0) {
                        distanceFromLastPoint = google.maps.geometry.spherical.computeDistanceBetween(lastElevation.location, elevation.location);
                        distanceFromStart += distanceFromLastPoint;
                    }

                    var distanceInMiles = metersToMiles(distanceFromStart);
                    var elevationInFeet = metersToFeet(elevation.elevation);

                    row = [];
                    row.push(distanceInMiles);
                    row.push(elevationInFeet);

                    // calculate gradient
                    var gradient = 0;
                    if (index > 0) {
                        gradient = (elevation.elevation - elevationAtLastPoint) / distanceFromLastPoint * 100;
                    }
                    var ttHtml = '<div style="padding:5px 5px 5px 5px;">Distance:<b>' + distanceInMiles.toFixed(1) + 'mi</b><br>Elevation:<b>' + elevationInFeet.toFixed(0) + 'ft</b><br>Grade:<b>' + gradient.toFixed(1) + '%</b></div>';
                    row.push(ttHtml);

                    dataTable.addRow(row);

                    elevationAtLastPoint = elevation.elevation;
                    
                    lastElevation = elevation;

                    mapDistanceToLocation[metersToMiles(distanceFromStart).toString()] = elevation.location;
                });

                var options = {
                    chartArea: { left: 60, top: 30, width: '60%', height: '70%' },
                    hAxis: {
                        format: '## mi',
                        textStyle: {
                            fontSize: 10
                        }
                    },
                    vAxis: {
                        format: '## ft',
                        textStyle: {
                            fontSize: 10
                        }
                    },
                    legend: {
                        position: 'none'
                    },
                    tooltip: {
                        isHtml: true
                    },
                    curveType: 'function'
            };

                elevationChart = $('#elevationChart')[0];
                var chart = new google.visualization.LineChart(elevationChart);

                chart.draw(dataTable, options);

                // Add our over/out handlers.
                google.visualization.events.addListener(chart, 'onmouseover', chartMouseOver);
                google.visualization.events.addListener(chart, 'onmouseout', chartMouseOut);

                function chartMouseOver(e) {
                    chart.setSelection([e]);

                    var item = chart.getSelection();
                    if (item != undefined) {
                        var selectedItem = item[0];
                        //console.log("item selected:  row=" + selectedItem.row + ", column=" + selectedItem.column);
                        //console.log("distance is: " + dataTable.getValue(selectedItem.row, 0));
                        //console.log("elevation is: " + dataTable.getValue(selectedItem.row, selectedItem.column));

                        var selectedLocation = mapDistanceToLocation[dataTable.getValue(selectedItem.row, 0)];
                        if (selectedLocation != undefined) {
                            //console.log("selected location: ");
                            //console.log(selectedLocation);
                            //console.log("lat is: " + selectedLocation.lat() + ", lng is: " + selectedLocation.lng());

                            // erase old marker, if it existed
                            if (mapMarker != null) {
                                mapMarker.setMap(null);
                            }

                            var markerOptions = {
                                strokeColor: '#FFFFFF',
                                strokeOpacity: 1,
                                strokeWeight: 2,
                                fillColor: '#0000FF',
                                fillOpacity: 1,
                                map: activityMap,
                                center: selectedLocation,
                                radius: 40,
                                editable: false,
                                draggable: false
                            };

                            mapMarker = new google.maps.Circle(markerOptions);

                        }
                    }

                }

                function chartMouseOut(e) {
                    chart.setSelection([{ 'row': null, 'column': null }]);
                }
            }

// UTILITY FUNCTIONS

            function metersToFeet(meters) {
                return meters * 3.28084;
            }

            function metersToMiles(distanceInMeters) {
                distanceInMiles = distanceInMeters * 0.000621371;
                return distanceInMiles;
            }

            function getMovingTime(moving_time) {

                hours = Math.floor(moving_time / 3600);

                minutes = Math.floor((moving_time - 3600 * hours) / 60);
                minutesStr = minutes.toString();
                if (minutesStr.length == 1) {
                    minutesStr = "0" + minutesStr;
                }

                seconds = Math.floor(moving_time - (3600 * hours) - (60 * minutes));
                secondsStr = seconds.toString();
                if (secondsStr.length == 1) {
                    secondsStr = "0" + secondsStr;
                }

                movingTime = "";
                if (hours > 0) {
                    movingTime = hours + ':';
                }

                movingTime += minutesStr + ':' + secondsStr;
                return movingTime;
            }

            function displayFriendSegmentEffort(segmentEffort) {

                movingTime = getMovingTime(segmentEffort.moving_time);

                // speed
                var speed = (segmentEffort.distance * 0.000621371) / (segmentEffort.moving_time / 3600);
                segmentEffort.speed = speed;

                // ride date
                d = new Date(segmentEffort.start_date_local);
                date = d.toDateString();

                rowToAdd = "<tr><td class='segmentEffortsRiderName'>" + segmentEffort.friendName + '</td><td>' + movingTime + '</td><td>' + speed.toFixed(1) + ' mph</td><td>' + date + '</td></tr>';
                $('#SegmentEffortsTable').append(rowToAdd);
            }

            function displaySummarySegmentEfforts(segment, segmentName, hideName) {

                $('#SegmentEffortsTable').empty();

                effortsNameHidden = hideName;

                //console.log('displaySummarySegmentEfforts invoked, segmentName=' + segmentName);

                buildSegmentSummary(segment);

                // loop through each athlete, outputting each segment effort for the given athlete (building data structure)
                segmentEffortsData = [];
                $.each(segmentEffortsByAthlete, function (athleteIndex, friendEfforts) {
                    friendName = friendEfforts.athleteName;
                    $.each(friendEfforts.segmentEffort, function (effortIndex, friendEffort) {
                        friendEffort.friendName = friendName;
                        segmentEffortsData.push(friendEffort);
                    });
                });

                segmentEffortsData.sort(function (a, b) {
                    return a.moving_time - b.moving_time;
                });

                // display data built just above (build data for possible sorting later)
                $.each(segmentEffortsData, function (index, segmentEffortData) {
                    displayFriendSegmentEffort(segmentEffortData);
                });

                // loop through each athlete, outputting each segment effort for the given athlete
                //$.each(segmentEffortsByAthlete, function (athleteIndex, friendEfforts) {
                //    friendName = friendEfforts.athleteName;
                //    $.each(friendEfforts.segmentEffort, function (effortIndex, friendEffort) {
                //        displayFriendSegmentEffort(friendEffort, friendName);
                //    });
                //});

                if (hideName) {
                    $('.segmentEffortsRiderName').addClass('hidden');
                    //$('td:nth-child(1)').hide(); - would also need to do this for th
                }

                $('#RideSummary').hide();               // hide the summary, map, and segment efforts table
                $('#map-canvas').hide();
                $('#elevationChart').hide();
                $('#DetailedActivity').hide();
                $('#SegmentSummary').show();
                $('#SegmentEffortsSection').show();    // show the friends segment efforts table

            }

            function retrieveSegmentGetSummarySegmentEfforts(segmentId, athletesToShow, hideName) {

                $.ajax({
                    url: 'http://' + hostName + ':8080/segment',
                    data: { "segmentId": segmentId.toString(), "athleteId": athleteId },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("retrieveSegmentGetSummarySegmentEfforts success");
                    //console.log(textStatus);
                    //console.log(data);

                    segment = data;

                    athletes = athletesToShow;

                    segmentEffortsByAthlete = [];

                    getSummarySegmentEfforts(segment, hideName);
                });
            }
                
            function getSummarySegmentEfforts(segment, hideName) {

                //console.log('getSummarySegmentEfforts invoked:' + segment.segmentId + ' ' + segment.segmentName);

                // get the id of the next athlete
                if (Object.keys(athletes).length == 0) {
                    displaySummarySegmentEfforts(segment, segment.segmentName, hideName);
                    return;
                }

                for (var friendId in athletes) {
                    athleteName = athletes[friendId];       // get an item
                    delete athletes[friendId];              // delete from aa
                    break;
                }

                //console.log('athlete id, name:');
                //console.log(friendId);
                //console.log(athleteName);

                // get summary activities for the specified athlete for the specified segment
                $.ajax({
                    url: 'http://' + hostName + ':8080/allEfforts',
                    data: { "segment_id": segment.segmentId.toString(), "athlete_id": athleteId, "friend_id": friendId.toString() },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("allEfforts success");
                    //console.log(textStatus);
                    //console.log(data);

                    summarySegmentEffort = {};
                    summarySegmentEffort.athleteId = friendId;
                    summarySegmentEffort.athleteName = athleteName;
                    summarySegmentEffort.segmentEffort = data;
                    segmentEffortsByAthlete.push(summarySegmentEffort);

                    getSummarySegmentEfforts(segment, hideName);
                });
            }

            function showMyEfforts(event) {
                //console.log("athleteId is " + athleteId);
                //console.log("button pressed: id = " + event.data.id.toString());
                //console.log(event.data);

                athletes = {};
                athletes[athleteId] = athleteName;

                segmentEffortsByAthlete = [];

                var stateObj = { athleteId: athleteId, athleteName: athleteName, stravaState: "myEfforts", "segment": event.data.segment };
                console.log("pushState myEfforts, stateObj: ");
                console.log(stateObj);
                history.pushState(stateObj, null, "StravaStatsHome.html?athleteId=" + athleteId + "&athleteName=" + athleteName + "&stravaState=myEfforts&segmentId=" + event.data.segment.segmentId.toString());

                currentStravaState = "myEfforts";

                getSummarySegmentEfforts(event.data.segment, true);
            }

            function showFriendsResults(event) {

                // get friends for the authenticated athlete
                $.ajax({
                    url: 'http://' + hostName + ':8080/friends',
                    data: { "athleteId": athleteId.toString() },
                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("friends success");
                    //console.log(textStatus);
                    //console.log(data);

                    athletes = {};

                    // data has the list of athletes
                    $.each(data, function (index, friend) {
                        athletes[friend.id] = friend.firstname + " " + friend.lastname;
                    });

                    // add authenticated athlete to the list
                    athletes[athleteId] = athleteName;

                    var stateObj = { athleteId: athleteId, stravaState: "friendsResults", "athletes": JSON.stringify(athletes), "segment": event.data.segment };
                    console.log("pushState friendsResults, stateObj: ");
                    console.log(stateObj);
                    history.pushState(stateObj, null, "StravaStatsHome.html?athleteId=" + athleteId + "&stravaState=friendsResults&segmentId=" + event.data.segment.segmentId.toString() + "&athletes=" + JSON.stringify(athletes));

                    currentStravaState = "friendsResults";

                    segmentEffortsByAthlete = [];

                    getSummarySegmentEfforts(event.data.segment, false);
                });
            }

            function buildSegmentEffortsRow(detailedEffort) {

                var segmentId = detailedEffort.segmentId;

                if (segmentId in segmentEffortOccurrenceCount) {
                    segmentEffortOccurrenceCount[segmentId] = segmentEffortOccurrenceCount[segmentId] + 1;
                }
                else {
                    segmentEffortOccurrenceCount[segmentId] = 0;
                }
                var uniqueSegmentId = segmentId + segmentEffortOccurrenceCount[segmentId].toString();

                var segmentEffortId = detailedEffort.segmentEffortId;

                // name
                var segmentEffortName = detailedEffort.segmentEffortName;

                // time
                var movingTime = getMovingTime(detailedEffort.movingTime);

                // distance
                var distanceInMiles = detailedEffort.segmentEffortDistance;

                // speed
                var speed = detailedEffort.segmentEffortDistance / (detailedEffort.movingTime / 3600);
                detailedEffort.speed = speed;

                // average grade
                var averageGrade = detailedEffort.averageGrade;

                // elevation gain
                var elevationGain = detailedEffort.totalElevationGain;

                rowToAdd = "<tr><td>" + segmentEffortName + "</td><td>" + movingTime + "</td><td>" + distanceInMiles.toFixed(1) + " mi</td><td>" + speed.toFixed(1) + " mph</td><td>" + averageGrade + "%</td><td>" + elevationGain.toFixed(0) + " ft</td><td>" + "<input id='" + uniqueSegmentId + "' type='submit' value='Show friends'/>" + '</td><td>' + "<input id='" + uniqueSegmentId + "MyEfforts" + "' type='submit' value='My efforts'/>" + '</td></tr>';
                $('#DetailedActivityTable').append(rowToAdd);

                // add button handler to show friends' result for this segment
                btnId = "#" + uniqueSegmentId;
                $(btnId).click({ segment: detailedEffort }, showFriendsResults);

                // add button handler to show my results for this segment
                btnId = "#" + uniqueSegmentId + "MyEfforts";
                $(btnId).click({ id: segmentId, name: segmentEffortName, segment: detailedEffort }, showMyEfforts);
            }

            function buildSegmentSummary(segment) {

                //console.log("buildSegmentSummary invoked");

                // segment name
                //var segmentName = segment.segmentEffortName;
                var segmentName = segment.segmentName;

                // segment distance
                var segmentDistance = segment.segmentDistance;

                // segment average grade
                var segmentAverageGrade = segment.averageGrade;

                // segment total elevation gain
                var segmentElevationGain = segment.totalElevationGain;

                $("#segmentName").html(segmentName);
                $("#segmentDistance").text(segmentDistance.toFixed(1) + " mi");
                $("#segmentAverageGrade").text(segmentAverageGrade + "%");
                $("#segmentTotalElevation").text(segmentElevationGain.toFixed(1) + " ft");
            }

            function buildRideSummary() {

                activity = selectedActivity;

                //console.log("buildRideSummary invoked, activity is ");
                //console.log(activity);

                // activityName
                activityName = activity.name;

                // ride date
                //d = new Date(activity.start_date_local);
                d = new Date(activity.startDateTime);
                date = d.toLocaleString();

                // distance
                miles = activity.distance;

                // riding time
                movingTime = getMovingTime(activity.movingTime);

                // elevation gain
                elevationGain = activity.totalElevationGain;

                // average speed (meters per second)
                mph = activity.averageSpeed;

                calories = activity.calories;

                $("#rideName").html(activityName);
                $("#rideDistance").text(miles.toFixed(1) + " mi");
                $("#rideTime").text(movingTime);
                $("#rideElevation").text(elevationGain + "ft");
                $("#rideSpeed").text(mph.toFixed(1) + "mph");
                $("#rideCalories").text(calories);
                $("#rideDateTime").html(date);
            }

            function buildSegmentEffortsTable(detailedEfforts) {
                //$('#activityName').html("Ride name is " + activity.name);

                // clear old event handlers
                $("#DetailedActivityTable input").unbind("click");

                // clear previous contents of table (if any)
                $('#DetailedActivityTable').empty();

                segmentEffortOccurrenceCount = {}

                $.each(detailedEfforts, function (index, detailedEffort) {
                    buildSegmentEffortsRow(detailedEffort);
                });
            }

            function showActivityDetails() {
                $('#SummaryActivities').hide();
                $('#RideSummary').show();
                $('#DetailedActivity').show();
                $('#elevationChart').show();
                $('#map-canvas').show();
            }

            function showMapBuilder() {
                $('#SummaryActivities').hide();
                $('#mapBuilder-canvas').show();
            }

            function getActivityEfforts(activityId, athleteId, activityName) {
                // get detailed activity data for the selected activity
                $.ajax({
                    url: 'http://' + hostName + ':8080/activityEfforts',
                    data: { "activityId": activityId, "athleteId": athleteId, "activityName": activityName },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("success");
                    //console.log(textStatus);
                    //console.log(data);

                    buildRideSummary();

                    selectedDetailedEfforts = data.detailedEfforts;
                    buildSegmentEffortsTable(data.detailedEfforts);

                    initializeMap(selectedActivity, "map-canvas");

                    //buildElevationGraphFromGoogleData(selectedActivity);
                    buildElevationGraph(selectedActivity);

                    showActivityDetails();
                });
            }

            function buildElevationGraph(activity) {

                var stream = JSON.parse(activity.stream);

                var distances;
                var elevations;
                var gradients;
                var locations;

                // at this point, stream is an array that includes a number of streams; need to pick out the required stream data
                for (i = 0; i < stream.length; i++) {
                    switch (stream[i].type) {
                        case 'distance':
                            distances = stream[i].data;
                            break;
                        case 'altitude':
                            elevations = stream[i].data;
                            break;
                        case 'grade_smooth':
                            gradients = stream[i].data;
                            break;
                        case 'latlng':
                            locations = stream[i].data;
                            break;
                    }
                }

                if (distances == undefined || elevations == undefined || gradients == undefined || locations == undefined) {
                    console.log("stream undefined");
                    return;
                }

                var dataTable = new google.visualization.DataTable();
                dataTable.addColumn('number', 'Distance');
                dataTable.addColumn('number', 'Elevation');
                dataTable.addColumn({ type: 'string', role: 'tooltip', 'p': { 'html': true } });

                var row = [];
                var mapDistanceToLocation = {};

                for (i = 0; i < distances.length; i++) {

                    var distance = distances[i];
                    var elevation = elevations[i];
                    var gradient = gradients[i];
                    var location = locations[i];

                    var distanceInMiles = metersToMiles(distance);
                    var elevationInFeet = metersToFeet(elevation);

                    row = [];
                    row.push(distanceInMiles);
                    row.push(elevationInFeet);

                    var ttHtml = '<div style="padding:5px 5px 5px 5px;">Distance:<b>' + distanceInMiles.toFixed(1) + 'mi</b><br>Elevation:<b>' + elevationInFeet.toFixed(0) + 'ft</b><br>Grade:<b>' + gradient.toFixed(1) + '%</b></div>';
                    row.push(ttHtml);

                    dataTable.addRow(row);

                    mapDistanceToLocation[metersToMiles(distance).toString()] = location;
                }

                var options = {
                    chartArea: { left: 60, top: 10, height: 160 },
                    hAxis: {
                        format: '## mi',
                        textStyle: {
                            fontSize: 10
                        }
                    },
                    vAxis: {
                        format: '## ft',
                        textStyle: {
                            fontSize: 10
                        }
                    },
                    legend: {
                        position: 'none'
                    },
                    tooltip: {
                        isHtml: true
                    },
                    //curveType: 'function'
                    width: 1800
                };

                elevationChart = $('#elevationChart')[0];
                var chart = new google.visualization.LineChart(elevationChart);

                chart.draw(dataTable, options);

                // draw marker at the beginning of the ride
                var startLocation = mapDistanceToLocation[dataTable.getValue(0, 0)];
                var startLatlng = new google.maps.LatLng(startLocation[0], startLocation[1]);
                var startMarkerOptions = {
                    strokeColor: '#FFFFFF',
                    strokeOpacity: 1,
                    strokeWeight: 2,
                    fillColor: '#00FF00',
                    fillOpacity: 1,
                    map: activityMap,
                    center: startLatlng,
                    radius: 50,
                    editable: false,
                    draggable: false
                };

                startMarker = new google.maps.Circle(startMarkerOptions);

                // add listener for when user clicks on activity start point
                google.maps.event.addListener(startMarker, 'click', segmentBuilderEvent);

                // Add our over/out handlers.
                google.visualization.events.addListener(chart, 'onmouseover', chartMouseOver);
                google.visualization.events.addListener(chart, 'onmouseout', chartMouseOut);

                function chartMouseOver(e) {
                    console.log("chartMouseOver");
                    chart.setSelection([e]);

                    var item = chart.getSelection();
                    if (item != undefined) {
                        var selectedItem = item[0];
                        //console.log("item selected:  row=" + selectedItem.row + ", column=" + selectedItem.column);
                        //console.log("distance is: " + dataTable.getValue(selectedItem.row, 0));
                        //console.log("elevation is: " + dataTable.getValue(selectedItem.row, selectedItem.column));

                        var selectedLocation = mapDistanceToLocation[dataTable.getValue(selectedItem.row, 0)];
                        if (selectedLocation != undefined) {
                            //console.log("selected location: ");
                            //console.log(selectedLocation);

                            //console.log("lat is: " + selectedLocation[0] + ", lng is: " + selectedLocation[1]);
                            var myLatlng = new google.maps.LatLng(selectedLocation[0], selectedLocation[1]);

                            // erase old marker, if it existed
                            if (mapMarker != null) {
                                mapMarker.setMap(null);
                            }

                            var markerOptions = {
                                strokeColor: '#FFFFFF',
                                strokeOpacity: 1,
                                strokeWeight: 2,
                                fillColor: '#0000FF',
                                fillOpacity: 1,
                                map: activityMap,
                                center: myLatlng,
                                radius: 50,
                                editable: false,
                                draggable: false
                            };

                            mapMarker = new google.maps.Circle(markerOptions);

                        }
                    }
                }

                function chartMouseOut(e) {
                    chart.setSelection([{ 'row': null, 'column': null }]);
                }
            }

            function showDetailsEventHandler(event) {

                showDetails(event.data.athleteId, event.data.activity, event.data.activityId, event.data.activityName);

                pushActivityDetails(event.data.athleteId, event.data.activity, event.data.activityId, event.data.activityName);
            }

            function showDetailsForActivity(activityId) {
                //debugger

                $.ajax({
                    url: 'http://' + hostName + ':8080/detailedActivity',
                    data: { "activityId": activityId, "athleteId": athleteId },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("detailedActivity success");
                    console.log(textStatus);
                    console.log(data);

                    var detailedActivity = data;

                    //debugger

                    showDetails(athleteId, detailedActivity, activityId, detailedActivity.activityName);
                    //pushActivityDetails(athleteId, detailedActivity.activity, activityId, detailedActivity.activityName);

                    //debugger
                });

            }

            function pushActivityDetails(athleteId, activity, activityId, activityName) {

                var stateObj = { athleteId: athleteId, stravaState: "activityDetails", activityId: activityId, activity: activity, activityName: activityName };
                console.log("pushState activityDetails, stateObj: ");
                console.log(stateObj);
                history.pushState(stateObj, null, "StravaStatsHome.html?athleteId=" + athleteId + "&stravaState=activityDetails&activityId=" + activityId);
            }

            function showDetails(athleteId, activity, activityId, activityName) {

                selectedActivity = activity;
                getActivityEfforts(activityId, athleteId, activityName);

                currentStravaState = "activityDetails";
            }

            function sortAscending(a, b) {
                if (a[currentSortColumn] < b[currentSortColumn])
                    return 1;
                if (a[currentSortColumn] > b[currentSortColumn])
                    return -1
                return 0;
            }

            function sortDescending(a, b) {
                if (a[currentSortColumn] > b[currentSortColumn])
                    return 1;
                if (a[currentSortColumn] < b[currentSortColumn])
                    return -1
                return 0;
            }

            function sortByColumn(self) {

                currentSortColumn = self[0].className;

                var sortOrder = "ascending";
                var sortFunction = sortAscending;

                if (activitiesTableColumnOrders[currentSortColumn] == "ascending") {
                    sortOrder = "descending";
                    sortFunction = sortDescending;
                }

                currentActivities.sort(sortFunction);

                // supposedly gets table from td
                //var a = $('td').closest('table');

                $(document).ready(function () {
                    $("#activitiesTable").find("tr:gt(0)").remove();
                })
                buildActivitiesTable(currentActivities);

                activitiesTableColumnOrders[currentSortColumn] = sortOrder;
            }

            function sortEffortsByColumn(self) {

                //currentSortColumn = self[0].className;
                currentSortColumn = self[0].classList[0];

                var sortOrder = "ascending";
                var sortFunction = sortAscending;

                if (effortsTableColumnOrders[currentSortColumn] == "ascending") {
                    sortOrder = "descending";
                    sortFunction = sortDescending;
                }

                segmentEffortsData.sort(sortFunction);

                // supposedly gets table from td
                //var a = $('td').closest('table');

                $(document).ready(function () {
                    $("#SegmentEffortsTable").find("tr:gt(0)").remove();
                })
                //buildActivitiesTable(currentActivities);
                $.each(segmentEffortsData, function (index, segmentEffortData) {
                    displayFriendSegmentEffort(segmentEffortData);
                });

                if (effortsNameHidden) {
                    $('.segmentEffortsRiderName').addClass('hidden');
                    //$('td:nth-child(1)').hide(); - would also need to do this for th
                }

                effortsTableColumnOrders[currentSortColumn] = sortOrder;
            }

            // get athleteId
            //athleteId = $('body').data('athleteid');
            //console.log("athleteId is ");
            //console.log(athleteId);
            //athleteName = $('body').data('athletename');
            //console.log("athleteName is ");
            //console.log(athleteName);

            //// get summary activities for the current athlete
            //$.ajax({
            //    url: 'http://' + hostName + ':8080/athleteActivities',
            //    type: 'GET',
            //    dataType: 'json',
            //    data: { "athleteId": athleteId.toString() },
            //    error: function () { alert('Failed!'); },
            //})
            //.success(function (data, textStatus, jqXHR) {
            //    //console.log("success");
            //    //console.log(textStatus);
            //    //console.log(data);

            //    currentActivities = data;

            //    sortActivitiesByDate(currentActivities);
            //    buildActivitiesTable(currentActivities);
            //    showActivitiesTable();

            //    // is this the appropriate point in the code to invoke pushState?
            //    console.log("pushState activities");
            //    var stateObj = { athleteId: athleteId, stravaState: "summaryActivities" };
            //    history.pushState(stateObj, null, "StravaStatsHome.html");
            //});

            var self;

            function getParameterByName(name, stringToSearch) {
                console.log("stringToSearch: " + stringToSearch);
                name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
                    //results = regex.exec(location.search);
                    results = regex.exec(stringToSearch);
                return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
            }

            function startup(pushState) {

                //console.log("document.URL: " + document.URL);
                //console.log("window.location");
                //console.log(window.location);
                ////console.log("location.search");
                ////console.log(document.location.search);
                //console.log("document.location");
                //var href = document.location.href;
                //console.log(document.location);
                //console.log("retrieving information from document.location, query parameters:");
                ////console.log("athleteId: " + getParameterByName("athleteId", document.location.search));
                ////console.log("stravaState: " + getParameterByName("stravaState", document.location.search));
                ////console.log("athleteId: " + getParameterByName("athleteId", document.location.href));
                ////console.log("stravaState: " + getParameterByName("stravaState", document.location.href));
                //console.log("href");
                //console.log(href);
                //console.log("athleteId: " + getParameterByName("athleteId", href));
                //console.log("stravaState: " + getParameterByName("stravaState", href));
                //console.log("href");
                //console.log(href);

                //athleteId = $('body').data('athleteid');

                console.log("startup() invoked");
                console.log("athleteId is ");
                console.log(athleteId);
                athleteName = $('body').data('athletename');
                console.log("athleteName is ");
                console.log(athleteName);

                currentStravaState = "summaryActivities";

                // get summary activities for the current athlete
                $.ajax({
                    url: 'http://' + hostName + ':8080/athleteActivities',
                    type: 'GET',
                    dataType: 'json',
                    data: { "athleteId": athleteId.toString() },
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    //console.log("success");
                    //console.log(textStatus);
                    //console.log(data);

                    currentActivities = data;

                    sortActivitiesByDate(currentActivities);
                    buildActivitiesTable(currentActivities);
                    showActivitiesTable();

                    // is this the appropriate point in the code to invoke pushState?
                    //debugger
                    //currentStravaState = "summaryActivities";

                    if (pushState) {
                        console.log("pushState summaryActivities");
                        var stateObj = { athleteId: athleteId, stravaState: "summaryActivities", currentActivities: currentActivities };
                        history.pushState(stateObj, null, "StravaStatsHome.html?athleteId=" + athleteId + "&stravaState=summaryActivities");
                    }
                });

            }

            // table column sort callback
            $("#SummaryActivities th").click(function () {
                //console.log(this);
                sortByColumn($(this));
            });

            $("#SegmentEffortsSection th").click(function () {
                //console.log(this);
                sortEffortsByColumn($(this));
            });

            $("#btnCompareSelectedRides").click(function () {

                var numRows = 0;
                var selectedRows = 0;

                var selectedActivityIds = [];

                $('#activitiesTable tr').each(function (i, row) {

                    var $row = $(row);
                    var $checkedBoxes = $row.find('input:checked');

                    if ($checkedBoxes.length == 1) {
                        selectedRows++;

                        var activityId = $row[0].id.substring(2);
                        selectedActivityIds.push(activityId);
                    }
                    numRows++;
                });

                //debugger
                var stateObj = { athleteId: athleteId, stravaState: "compareActivities", activityIds: selectedActivityIds };
                console.log("pushState compareRides, stateObj: ");
                console.log(stateObj);
                history.pushState(stateObj, null, "StravaStatsHome.html?athleteId=" + athleteId + "&stravaState=compareActivities&activityIds=" + selectedActivityIds.toString());

                currentStravaState = "compareActivities";

                compareActivities(selectedActivityIds);
            });

            window.onpopstate = function (event) {

                //debugger

                //var newState = JSON.stringify(event.state);

                console.log("onpopstate, history.length: ", history.length);

                //console.log("state: " + JSON.stringify(event.state));
                console.log("document.URL: " + document.URL);

                var newState = event.state.stravaState;

                console.log("navigate to state: " + newState);

                // if the new state is the same as the existing state, don't do anything
                if (currentStravaState == newState) {
                    console.log("currentStravaState == newState == " + newState + ", ignore popstate event");
                    return;
                }

                if (newState == "summaryActivities") {
                    if (currentActivities == undefined) {
                        currentActivities = event.state.currentActivities;
                    }
                    sortActivitiesByDate(currentActivities);
                    buildActivitiesTable(currentActivities);
                    showActivitiesTable();
                }
                else if (newState == "activityDetails") {
                    athleteId = event.state.athleteId;
                    var activity = event.state.activity;
                    var activityId = event.state.activityId;
                    var activityName = event.state.activityName;
                    console.log("activityId=" + activityId);
                    showDetails(athleteId, activity, activityId, activityName);
                }
                else if (newState == "compareActivities") {
                    athleteId = event.state.athleteId;
                    var selectedActivityIds = event.state.activityIds;
                    compareActivities(selectedActivityIds);
                }
                else if (newState == "myEfforts") {
                    console.log("state: " + JSON.stringify(event.state));

                    athleteId = event.state.athleteId;
                    athleteName = event.state.athleteName;
                    var segment = event.state.segment;

                    athletes = {};
                    athletes[athleteId] = athleteName;

                    segmentEffortsByAthlete = [];

                    getSummarySegmentEfforts(segment, true);
                }
                else if (newState == "friendsResults") {
                    console.log("state: " + JSON.stringify(event.state));

                    athleteId = event.state.athleteId;
                    var segment = event.state.segment;
                    var friends = JSON.parse(event.state.athletes);
                    console.log("friends:");
                    console.log(friends);

                    athletes = friends;

                    segmentEffortsByAthlete = [];

                    getSummarySegmentEfforts(segment, false);
                }

                currentStravaState = newState;
            };

            window.onload = function (event) {
                //alert("onload, state: " + history.state);
                console.log("window.onload invoked");
            };

// MAP BUILDER
            var buildingTrailSegment = false;

            var trailIntersections = [];
            var segmentStartTrailIntersection = null;
            var segmentStartIndex = -1;

            function mapBuilderInvokedEventHandler(event) {

                selectedActivity = event.data.activity;

                currentStravaState = "mapBuilder";

                var stateObj = { athleteId: event.data.athleteId, stravaState: "activityDetails", activityId: event.data.activityId, activity: selectedActivity, activityName: event.data.activityName };
                console.log("pushState mapBuilder, stateObj: ");
                console.log(stateObj);
                history.pushState(stateObj, null, "StravaStatsHome.html?athleteId=" + event.data.athleteId + "&stravaState=mapBuilder&activityId=" + event.data.activityId);

                initializeMap(selectedActivity, "mapBuilder-canvas");

                showMapBuilder();

                google.maps.event.addListener(activityMap, 'click', failedSegmentBuilderEvent);
                google.maps.event.addListener(activityPath, 'click', segmentBuilderEvent);

                // retrieve data from the database if it exists
                trailIntersections = []; // may not be necessary - might already be guaranteed to be empty
                readTrailDataFromDB();
            }

            function readTrailDataFromDB() {

                var trailIntersectionsFromDB;
                var trails;
                var trailsAtTrailIntersections;

                var trailIntersectionsRetrieved = false;
                var trailsRetrieved = false;
                var trailsAtTrailIntersectionsRetrieved = false;

                // trailIntersections
                $.ajax({
                    url: 'http://' + hostName + ':8080/trailIntersections',
                    type: 'GET',
                    dataType: 'json',
                    data: {},
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    trailIntersectionsFromDB = data;
                    trailIntersectionsRetrieved = true;

                    if (trailIntersectionsRetrieved && trailsRetrieved && trailsAtTrailIntersectionsRetrieved) {
                        resolveTrailData(trailIntersectionsFromDB, trails, trailsAtTrailIntersections);
                        return;
                    }
                });

                // trails
                $.ajax({
                    url: 'http://' + hostName + ':8080/trails',
                    type: 'GET',
                    dataType: 'json',
                    data: {},
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    trails = data;
                    trailsRetrieved = true;

                    if (trailIntersectionsRetrieved && trailsRetrieved && trailsAtTrailIntersectionsRetrieved) {
                        resolveTrailData(trailIntersectionsFromDB, trails, trailsAtTrailIntersections);
                        return;
                    }
                });

                // trailsAtTrailIntersections
                $.ajax({
                    url: 'http://' + hostName + ':8080/trailsAtTrailIntersections',
                    type: 'GET',
                    dataType: 'json',
                    data: {},
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    trailsAtTrailIntersections = data;
                    trailsAtTrailIntersectionsRetrieved = true;

                    if (trailIntersectionsRetrieved && trailsRetrieved && trailsAtTrailIntersectionsRetrieved) {
                        resolveTrailData(trailIntersectionsFromDB, trails, trailsAtTrailIntersections);
                        return;
                    }
                });
            }

            function resolveTrailData(trailIntersectionsFromDB, trails, trailsAtTrailIntersections) {

                debugger;

                $.each(trailIntersectionsFromDB, function (index, trailIntersectionFromDB) {
                    var origin = new google.maps.LatLng(trailIntersectionFromDB.latitude, trailIntersectionFromDB.longitude);

                    var trailIntersection = new TrailIntersectionMin(
                        trailIntersectionFromDB.name,
                        origin,
                        trailIntersectionFromDB.elevation,
                        trailIntersectionFromDB.activityId,
                        trailIntersectionFromDB.id
                        );

                    trailIntersections.push(trailIntersection);
                    //google.maps.event.addListener(trailIntersectionMarker, 'click', trailIntersectionSelectedEventHandler);
                });

                var trailMins = [];

                $.each(trails, function (index, trailFromDB) {

                    var trail = new TrailMin(
                        trailFromDB.length,
                        trailFromDB.path,
                        trailFromDB.elevationGain,
                        trailFromDB.elevationGainReverseDirection,
                        trailFromDB.id,
                        trailFromDB.destinationTrailIntersectionId
                        );

                    trailMins.push(trail);
                });

                addDestinationTrailIntersectionsToTrails(trailMins);

                addTrailsFromTrailIntersections(trailsAtTrailIntersections, trailMins);

                debugger;
            }

            // Iterate through trail objects
            // Using destinationTrailIntersectionId (from trail objects), find the matching destinationTrailIntersection and set destinationTrailIntersection member
            function addDestinationTrailIntersectionsToTrails(trailMins) {

                $.each(trailMins, function (trailIndex, trailMin) {
                    //minTrail = trailMins[trailIndex];
                    $.each(trailIntersections, function (trailIntersectionIndex, minTrailIntersection) {
                        if (trailMin.destinationTrailIntersectionId == minTrailIntersection.id) {
                            trailMin.destinationTrailIntersection = minTrailIntersection;
                        }
                    });
                });
            }

            // Iterate through data returned from trailAtTrailIntersection
            // Find trailIntersection object associated with trailIntersectionId
            // Find trail object associated with trailId
            // Push trail object onto trailIntersection.trailList
            function addTrailsFromTrailIntersections(trailsAtTrailIntersections, trailMins) {
                $.each(trailsAtTrailIntersections, function (index, trailAtTrailIntersection) {

                    //debugger;

                    var trailIntersection = getTrailIntersection(trailAtTrailIntersection.trailIntersectionId);
                    if (trailIntersection == null) debugger;

                    var trail = getTrail(trailMins, trailAtTrailIntersection.trailId);
                    if (trail == null) debugger;

                    trailIntersection.trailList.push(trail);
                });
            }

            function getTrailIntersection(trailIntersectionId) {
                var matchingTrailIntersection = null;
                $.each(trailIntersections, function (index, trailIntersection) {
                    if (trailIntersection.id == trailIntersectionId) {
                        matchingTrailIntersection = trailIntersection;
                        return;
                    }
                });
                return matchingTrailIntersection;
            }

            function getTrail(minTrails, trailId) {
                var matchingTrail = null;
                $.each(minTrails, function (index, minTrail) {
                    if (minTrail.id == trailId) {
                        matchingTrail = minTrail;
                    }
                });
                return matchingTrail;
            }

            // segmentBuilderEvent is invoked when user clicks on the path (however, not on a previously created trail intersection)
            function segmentBuilderEvent(event) {

                // event.latLng
                console.log("lat=" + event.latLng.lat() + ",longitude=" + event.latLng.lng());

                // get the point along the path that is closest to where the user clicked
                var pointOnPath = getClosestPoint(event.latLng.lat(), event.latLng.lng());
                console.log("locationInfo=");
                console.log(pointOnPath);

                // get distance from start of activity and index
                var addTrailSegment = confirm("Do you want to create a new trail intersection " + pointOnPath.distanceFromStart.toFixed(2) + " miles from the start of the ride (at point " + pointOnPath.index.toString() + " of " + pointOnPath.numberOfPoints.toString() + ")?");
                if (addTrailSegment == true) {
                    var trailIntersectionName = prompt("Enter trail intersection name");
                    if (trailIntersectionName != null && trailIntersectionName != "") {

                        // put a marker down at the TrailIntersection point
                        var trailIntersectionMarkerOptions = {
                            strokeColor: '#FFFFFF',
                            strokeOpacity: 1,
                            strokeWeight: 2,
                            fillColor: '#000000',
                            fillOpacity: 1,
                            map: activityMap,
                            center: pointOnPath.latLng,
                            radius: 25,
                            editable: false,
                            draggable: false
                        };

                        trailIntersectionMarker = new google.maps.Circle(trailIntersectionMarkerOptions);

                        // add a TrailIntersection object at the point on the activity closest to the selected point
                        addTrailIntersectionThenTrail(trailIntersectionName, pointOnPath);
                        //var trailIntersection = new TrailIntersection(trailIntersectionName, pointOnPath.latLng, pointOnPath.elevation, pointOnPath.index, selectedActivity.activityId, pointOnPath);
                        //trailIntersections.push(trailIntersection);
                        //google.maps.event.addListener(trailIntersectionMarker, 'click', trailIntersectionSelectedEventHandler);

                        //if (buildingTrailSegment) {
                        //    // end of trail; add trail to segmentStartTrailIntersection.trailList
                        //    addTrail(trailIntersection, pointOnPath);
                        //}
                        //else {
                        //    segmentStartTrailIntersection = trailIntersection;
                        //}

                        buildingTrailSegment = !buildingTrailSegment;

                        console.log("segmentBuilderEvent, buildingTrailSegment = " + buildingTrailSegment.toString());
                    }
                }
            }

            function trailIntersectionSelectedEventHandler(event) {

                // user clicked on a trail intersection - find out which one
                var selectedTrailIntersection = null;
                var selectedLat = this.center.lat();
                var selectedLng = this.center.lng();

                $.each(trailIntersections, function (index, trailIntersection) {
                    var originLat = trailIntersection.origin.lat();
                    var originLng = trailIntersection.origin.lng();
                    if (selectedLat == originLat && selectedLng == originLng) {
                        selectedTrailIntersection = trailIntersection;
                        return;
                    }
                });

                if (selectedTrailIntersection != null) {
                    console.log("clicked on " + selectedTrailIntersection.name);

                    var useTrailIntersection = confirm("Do you want to use the existing trail intersection " + selectedTrailIntersection.name + "?");
                    if (useTrailIntersection == true) {
                        if (buildingTrailSegment) {
                            // add a trail segment from the origin to this trail intersection
                            // origin is
                            //      segmentStartTrailIntersection
                            // destination is
                            //      location associated with selectedTrailIntersection
                            debugger;
                            addTrail(selectedTrailIntersection, segmentStartTrailIntersection.pointOnPath);
                        }
                        else {
                            segmentStartTrailIntersection = selectedTrailIntersection;
                        }
                        buildingTrailSegment = !buildingTrailSegment;
                    }
                }
                else {
                    console.log("Error - trail intersection not found");
                }
            }

            function addTrailIntersectionThenTrail(trailIntersectionName, pointOnPath) {

                var trailIntersection = new TrailIntersection(trailIntersectionName, pointOnPath.latLng, pointOnPath.elevation, pointOnPath.index, selectedActivity.activityId, pointOnPath, buildingTrailSegment);
                trailIntersections.push(trailIntersection);
                google.maps.event.addListener(trailIntersectionMarker, 'click', trailIntersectionSelectedEventHandler);

                if (buildingTrailSegment) {
                    // end of trail; add trail to segmentStartTrailIntersection.trailList
                    //addTrail(trailIntersection, pointOnPath);
                }
                else {
                    segmentStartTrailIntersection = trailIntersection;
                }

            }

            // add a trail from 'segmentStartTrailIntersection' / 'pointOnPath' to 'trailIntersection'
            function addTrail(trailIntersection, pointOnPath) {

                var trailLength = 0;
                var path = [];
                var elevationGain = 0;
                var elevationGainReverseDirection = 0;

                // for now, assume that originIndex < destinationIndex
                var trailPointIndex = segmentStartTrailIntersection.index + 1;
                while (trailPointIndex <= trailIntersection.index) {

                    trailLength += (pointOnPath.distances[trailPointIndex] - pointOnPath.distances[trailPointIndex - 1]);
                    path.push(pointOnPath.locations[trailPointIndex]);

                    if (pointOnPath.elevations[trailPointIndex] > pointOnPath.elevations[trailPointIndex - 1]) {
                        elevationGain += pointOnPath.elevations[trailPointIndex] - pointOnPath.elevations[trailPointIndex - 1];
                    }

                    if (pointOnPath.elevations[trailPointIndex] < pointOnPath.elevations[trailPointIndex - 1]) {
                        elevationGainReverseDirection += pointOnPath.elevations[trailPointIndex - 1] - pointOnPath.elevations[trailPointIndex];
                    }

                    trailPointIndex++;
                }

                trail = new Trail(trailLength, path, elevationGain, elevationGainReverseDirection, segmentStartTrailIntersection, trailIntersection);

                //segmentStartTrailIntersection.trailList.push(trail);
            }

            function Trail(length, path, elevationGain, elevationGainReverseDirection, startTrailIntersection, trailIntersection) {

                this.destinationTrailIntersection = trailIntersection;
                this.destinationTrailIntersectionId = trailIntersection.id;
                this.length = length;
                this.path = path;
                this.elevationGain = elevationGain;
                this.elevationGainReverseDirection = elevationGainReverseDirection;

                var thisTrail = this;


                // add trail to database
                $.ajax({
                    url: 'http://' + hostName + ':8080/trail',
                    data: { "destinationTrailIntersectionId": this.destinationTrailIntersectionId, "length": this.length, "path": JSON.stringify(this.path), "elevationGain": this.elevationGain, "elevationGainReverseDirection": this.elevationGainReverseDirection },        
                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("trail success");
                    console.log(textStatus);
                    console.log(data);

                    thisTrail.id = data;

                    startTrailIntersection.trailList.push(thisTrail);

                    // add trail to trail intersection in db
                    $.ajax({
                        url: 'http://' + hostName + ':8080/trailAtTrailIntersection',
                        data: { "trailIntersectionId": startTrailIntersection.id, "trailId": thisTrail.id },
                        type: 'GET',
                        dataType: 'json',
                        error: function () { alert('Failed!'); },
                    })
                    .success(function (data, textStatus, jqXHR) {
                        console.log("trailAtTrailIntersection success");
                        console.log(textStatus);
                        console.log(data);
                    });
                });
            }

            function TrailMin(length, path, elevationGain, elevationGainReverserDirection, id, destinationTrailIntersectionId) {
                this.length = length;
                this.path = path;
                this.elevationGain = elevationGain;
                this.elevationGainReverserDirection = elevationGainReverserDirection;
                this.id = id;
                this.destinationTrailIntersectionId = destinationTrailIntersectionId
            }

            function TrailIntersectionMin(name, origin, elevation, activityId, id) {
                this.name = name;
                this.origin = origin;
                this.elevation = elevation;
                this.activityId = activityId;
                this.id = id;
                this.trailList = [];
            }

            function TrailIntersection(name, origin, elevation, index, activityId, pointOnPath, addTrailToIntersection) {
                this.name = name;
                this.origin = origin;
                this.elevation = elevation;
                this.index = index;
                this.activityId = activityId;
                this.pointOnPath = pointOnPath;
                this.trailList = [];

                var thisTrailIntersection = this;

                // add object to database
                $.ajax({
                    url: 'http://' + hostName + ':8080/trailIntersection',
                    data: { "name": this.name, "latitude": this.origin.lat(), "longitude": this.origin.lng(), "elevation": this.elevation, "activityId": this.activityId },
                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("trailIntersection success");
                    console.log(textStatus);
                    console.log(data);

                    //debugger;

                    thisTrailIntersection.id = data;

                    if (addTrailToIntersection) {
                        addTrail(thisTrailIntersection, pointOnPath);
                    }
                });
            }


            function failedSegmentBuilderEvent(event) {
                console.log("missed");
                segmentBuilderEvent(event);
            }

            function getClosestPoint(lat, lng) {

                var stream = JSON.parse(selectedActivity.stream);

                var distances;
                var locations;
                var elevations;

                // at this point, stream is an array that includes a number of streams; need to pick out the required stream data
                for (i = 0; i < stream.length; i++) {
                    switch (stream[i].type) {
                        case 'distance':
                            distances = stream[i].data;
                            break;
                        case 'latlng':
                            locations = stream[i].data;
                            break;
                        case 'altitude':
                            elevations = stream[i].data;
                            break;
                    }
                }

                if (locations == undefined || elevations == undefined) {
                    console.log("stream undefined");
                    return -1;
                }

                var locationInfo = {};
                var minDistance = 9999;
                var minIndex = -1;

                for (i = 0; i < locations.length; i++) {

                    var location = locations[i];

                    var pointsDistance = getDistance(location[0], location[1], lat, lng);
                    if (Math.min(minDistance, pointsDistance) != minDistance) {
                        minIndex = i;
                        minDistance = pointsDistance;
                    }
                }

                console.log("segmentBuilderEvent: minIndex=" + minIndex.toString() + ", minDistance=" + minDistance.toString());

                locationInfo.index = minIndex;
                locationInfo.numberOfPoints = locations.length;
                locationInfo.distanceFromPath = metersToFeet(minDistance * 1000);
                locationInfo.distanceFromStart = metersToMiles(distances[minIndex]);
                locationInfo.distances = distances;
                locationInfo.locations = locations;
                locationInfo.elevations = elevations;

                locationInfo.latLng = new google.maps.LatLng(locations[minIndex][0], locations[minIndex][1]);
                locationInfo.elevation = elevations[minIndex];

                return locationInfo;
            }

            function getDistance(lat1, lon1, lat2, lon2) {

                var R = 6371; // km
                var φ1 = toRad(lat1);
                var φ2 = toRad(lat2);
                var Δφ = toRad(lat2 - lat1);
                var Δλ = toRad(lon2 - lon1);

                var a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                        Math.cos(φ1) * Math.cos(φ2) *
                        Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                var d = R * c;

                return d;
            }

            function toRad(x) {
                return x * Math.PI / 180;
            }


// ENTRY POINT, determine what to do by fetching athleteId / stravaState, etc.

            //debugger

            console.log("startup, history.state: ");
            console.log(history.state);
            console.log("startup history.length: ", history.length);

            if (history.state == null) {
                console.log("retrieve athleteId from body");
                athleteId = $('body').data('athleteid');
                console.log("athleteId: " + athleteId);

                // note the intended use of 'thleteIdPlaceholder'
                if (athleteId == null || athleteId == undefined || athleteId == "" || athleteId.toString().substr(1) == "thleteIdPlaceholder") {

                    console.log("athleteId from body invalid, retrieve from document.URL");
                    athleteId = getParameterByName("athleteId", document.URL);
                    console.log("athleteId from URL: " + athleteId);

                    if (athleteId == null || athleteId == undefined || athleteId == "" || athleteId.toString().substr(1) == "thleteIdPlaceholder") {
                        console.log("scenario: user navigated directly to site");
                        console.log("athleteId completely unavailable, interpret as direct connect.");
                        // scenario: user navigated directly to StravaStatsHome.html
                        // redirect to Strava
                        window.location.replace("https://www.strava.com/oauth/authorize?client_id=2055&response_type=code&redirect_uri=http://" + hostName + ":8080/StravaStatsHome.html");
                    }
                    else {
                        console.log("scenario: user clicked on bookmark or perhaps used the browser's forward / back button");
                        // scenario: user clicked on bookmark
                        // get initial state
                        // for now, assume summary activities
                        //debugger
                        var targetState = getParameterByName("stravaState", document.URL);
                        console.log("targetState = " + targetState);

                        if (targetState == "summaryActivities") {
                            startup(false);
                        }
                        else if (targetState == "activityDetails") {
                            var activityId = getParameterByName("activityId", document.URL);
                            console.log("activityId: " + activityId);
                            showDetailsForActivity(activityId);
                        }
                        else if (targetState == "compareActivities") {
                            var activityIdsParam = getParameterByName("activityIds", document.URL);
                            var selectedActivityIds = activityIdsParam.split(',');
                            compareActivities(selectedActivityIds);
                        }
                        else if (targetState == "myEfforts") {
                            athleteId = getParameterByName("athleteId", document.URL);
                            var segmentId = getParameterByName("segmentId", document.URL);

                            athletes = {};
                            athletes[athleteId] = athleteName;

                            retrieveSegmentGetSummarySegmentEfforts(segmentId, athletes, true);
                        }
                        else if (targetState == "friendsResults") {
                            console.log("state: " + JSON.stringify(event.state));
                            athleteId = getParameterByName("athleteId", document.URL);
                            var segmentId = getParameterByName("segmentId", document.URL);
                            var athletes = getParameterByName("athletes", document.URL);
                            var friends = JSON.parse(athletes);

                            retrieveSegmentGetSummarySegmentEfforts(segmentId, friends, false);
                        }

                        return;
                    }
                }
                else {
                    console.log("scenario: user connected to Strava from separate page; security token retrieved");
                    // athleteId is set
                    // scenario: connected to Strava from separate page; security token retrieved
                    // history.state == null && athleteId from body is good. means source was Strava
                    // launch summary activities stream
                    // return
                    startup(true);
                    return;
                }
            }
            else {
                // scenarios
                //      refresh
                //      in app, go to google, hit Back - history is still there? (sometimes it is)
                //debugger

                console.log("history.state exists");
                athleteId = history.state.athleteId;
                console.log("athleteId from history.state: " + athleteId);

                // get intended state
                var targetState = history.state.stravaState;
                console.log("targetState = " + targetState);

                if (targetState == "summaryActivities") {
                    startup(false);
                }
                else if (targetState == "activityDetails") {
                    athleteId = history.state.athleteId;
                    var activity = history.state.activity;
                    var activityId = history.state.activityId;
                    var activityName = history.state.activityName;
                    console.log("activityId=" + activityId);
                    showDetails(athleteId, activity, activityId, activityName);
                    //pushActivityDetails(athleteId, activity, activityId, activityName);
                }
                else if (targetState == "compareActivities") {
                    athleteId = history.state.athleteId;
                    var selectedActivityIds = history.state.activityIds;
                    compareActivities(selectedActivityIds);
                }
                else if (targetState == "myEfforts") {
                    console.log("history.state: " + JSON.stringify(history.state));

                    athleteId = history.state.athleteId;
                    athleteName = history.state.athleteName;
                    var segment = history.state.segment;

                    athletes = {};
                    athletes[athleteId] = athleteName;

                    segmentEffortsByAthlete = [];

                    getSummarySegmentEfforts(segment, true);
                }
                else if (targetState == "friendsResults") {
                    console.log("history.state: " + JSON.stringify(history.state));

                    athleteId = history.state.athleteId;
                    var segment = history.state.segment;
                    var friends = JSON.parse(history.state.athletes);
                    console.log("friends:");
                    console.log(friends);

                    athletes = friends;

                    segmentEffortsByAthlete = [];

                    getSummarySegmentEfforts(segment, false);
                }

                return;
            }

        });
    </script>

</head>
<body data-athleteId="athleteIdPlaceholder", data-athleteName="athleteNamePlaceholder">
    <!--<p>My Strava Data</p>-->

    <!--<div class="background" style="position: relative; width:1900px; height:900px;">-->
    <div class="background" style="position: relative; width:1900px;">

        <div id="RideSummary">
          <table class="summaryTable">

            <tr class="summaryDataRow">
                <td id="rideName"></td>
                <td id="rideTime"></td>        
                <td id="rideElevation"></td>
                <td id="rideDistance"></td>
                <td id="rideSpeed"></td>
                <td id="rideCalories"></td>
            </tr>

            <tr class="summaryLabels">
                <td id="rideDateTime"></td>
                <td>Time</td>        
                <td>Elevation</td>
                <td>Distance</td>
                <td>Speed</td>
                <td>Calories</td>
            </tr>

          </table>
        </div>

        <div id="SummaryActivities" class="hidden">
            <button type="button" id="btnCompareSelectedRides">Compare selected rides</button>
            <table id="activitiesTable">
                <tr>
                    <th></th>
                    <th class="startDateTime">Date</th>
                    <th class="name">Name</th>
                    <th class="movingTime">Riding Time</th>        
                    <th class="distance">Distance</th>
                    <th class="totalElevationGain">Elevation</th>
                    <th class="averageSpeed">Average Speed</th>
                    <th class="calories">Calories</th>
                    <th></th>
                    <th></th>
                </tr>

            </table>
        </div>

        <div id="ComparedActivities" class="hidden">
            <table id="comparedActivitiesTable"></table>
        </div>

        <div id="DetailedActivity" class="detailsActivity">
            <table id="DetailedActivityTable" class="detailsActivityTable">
                <tr>
                    <th>Name</th>
                    <th>Time</th>        
                    <th>Distance</th>
                    <th>Speed</th>
                    <th>Average Grade</th>
                    <th>Elevation Gain</th>
                </tr>
            </table>
        </div>

        <div id="SegmentSummary">
          <table class="summaryTable">

            <tr class="summaryDataRow">
                <td id="segmentName"></td>
                <td id="segmentDistance"></td>        
                <td id="segmentAverageGrade"></td>
                <td id="segmentTotalElevation"></td>
            </tr>

            <tr class="summaryLabels">
                <td></td>        
                <td>Distance</td>
                <td>Average Grade</td>
                <td>Elevation</td>
            </tr>

          </table>
        </div>

        <div id="SegmentEffortsSection" class="detailsActivity">
            <table id="SegmentEffortsTable" class="detailsActivityTable">
                <tr>
                    <th class="friendName segmentEffortsRiderName">Name</th>
                    <th class="moving_time">Time</th>        
                    <th class="speed">Speed</th>        
                    <th class="start_date_local">Date</th>        
                </tr>
            </table>
        </div>


        <div id="elevationChart"></div>

        <div id="map-canvas"></div>

        <div id="mapBuilder-canvas"></div>
    </div>
</body>
</html>
