<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>StravaStatsByTed</title>
    <script src="js/jquery-2.1.1.min.js"></script>

    <script>
        $(document).ready(function () {
          
            var athleteIds = [];
            var segmentEffortsByAthlete = [];

            function getDistance(distanceInMeters) {
                distanceInMiles = distanceInMeters * 0.000621371;
                return distanceInMiles;
            }

            function getMovingTime(moving_time) {

                hours = Math.floor(moving_time / 3600);

                minutes = Math.floor((moving_time - 3600 * hours) / 60);
                minutesStr = minutes.toString();
                if (minutesStr.length == 1) {
                    minutesStr = "0" + minutesStr;
                }

                seconds = Math.floor(moving_time - (3600 * hours) - (60 * minutes));
                secondsStr = seconds.toString();
                if (secondsStr.length == 1) {
                    secondsStr = "0" + secondsStr;
                }

                movingTime = "";
                if (hours > 0) {
                    movingTime = hours + ':';
                }

                movingTime += minutesStr + ':' + secondsStr;
                return movingTime;
            }

            function displayFriendSegmentEffort(segmentEffort) {

                movingTime = getMovingTime(segmentEffort.moving_time);

                // ride date
                d = new Date(segmentEffort.start_date_local);
                date = d.toDateString();

                rowToAdd = '<tr><td>' + segmentEffort.athlete.id.toString() + '</td><td>' + movingTime + '</td><td>' + date + '</td></tr>';
                $('#SegmentEffortsFriendsTable').append(rowToAdd);
                console.log("row added: " + rowToAdd);
            }

            function displaySummarySegmentEfforts(segmentName) {
                console.log('displaySummarySegmentEfforts invoked, segmentName=' + segmentName);

                $('#effortName').html("Segment is " + segmentName);

                // loop through each athlete, outputting each segment effort for the given athlete
                $.each(segmentEffortsByAthlete, function (index, friendEfforts) {
                    $.each(friendEfforts.segmentEffort, function (index, friendEffort) {
                        displayFriendSegmentEffort(friendEffort);
                    });
                });
            }

            function getSummarySegmentEfforts(segmentId, segmentName) {
                console.log('getSummarySegmentEfforts invoked:' + segmentId + ' ' + segmentName);

                // get the id of the next athlete
                if (athleteIds.length == 0) {
                    displaySummarySegmentEfforts(segmentName);
                    return;
                }

                athleteId = athleteIds.shift();

                console.log('athleteId:' + athleteId);

                // get summary activities for the specified athlete
                $.ajax({
                    url: 'http://localHost:8080/getSegmentEffortsForAthlete.html',
                    data: { "segment_id": segmentId.toString(), "athlete_id": athleteId.toString() },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("getSegmentEffortsForAthlete success");
                    console.log(textStatus);
                    console.log(data);

                    summarySegmentEffort = {};
                    summarySegmentEffort.athleteId = athleteId;
                    summarySegmentEffort.segmentEffort = data;
                    segmentEffortsByAthlete.push(summarySegmentEffort);

                    getSummarySegmentEfforts(segmentId, segmentName);
                });
            }

            function showFriendsResults(event) {
                console.log("button pressed: id = " + event.data.id.toString());
                console.log(event.data.name);

                segmentEffortsByAthlete = [];

                athleteIds = [];
                athleteIds.push('1681275');
                athleteIds.push('2843574');

                getSummarySegmentEfforts(event.data.id, event.data.name);

                //getSegmentEffortsForAthlete(event.data.id, '1681275');   // Joel Brown
                //getSegmentEffortsForAthlete(event.data.id, '2843574');   // Me
                //displaySummarySegmentEfforts(event.data.name);
                $('#DetailedActivity').hide();         // show the segment efforts table
                $('#SegmentEffortsFriends').show();    // show the friends segment efforts table
            }

            function buildSegmentEffortsRow(segmentEffort) {

                segmentEffortId = segmentEffort.segmentEffortId;

                name = segmentEffort.segmentEffortName;

                //movingTime = getMovingTime(segmentEffort.moving_time);
                movingTime = getMovingTime(segmentEffort.movingTime);

                //distanceInMiles = getDistance(segmentEffort.distance);
                distanceInMiles = segmentEffort.segmentEffortDistance;

                rowToAdd = '<tr><td>' + name + '</td><td>' + movingTime + '</td><td>' + distanceInMiles.toFixed(1) + '</td><td>' + "<input id='" + segmentEffortId.toString() + "' type='submit' value='Show friends'/>" + '</td></tr>';
                $('#DetailedActivityTable').append(rowToAdd);

                // add button handler to show friends' result for this segment
                btnId = "#" + segmentEffortId.toString();
                $(btnId).click({ id: segmentEffortId.toString(), name: name }, showFriendsResults);

            }

            function buildSegmentEffortsTable(activity) {
                $('#activityName').html("Ride name is " + activity.name);

                segmentEfforts = activity.detailedEfforts;
                $.each(segmentEfforts, function (index, segmentEffort) {
                    buildSegmentEffortsRow(segmentEffort);
                });
            }

            function showActivityDetailsTable(event) {
                $('#SummaryActivities').hide();
                $('#DetailedActivity').show();
            }

            function getDetailedActivity(activityId) {
                // get detailed activity data for the current athlete
                $.ajax({
                    url: 'http://localHost:8080/getDetailedActivity.html',
                    data: { "activityId": activityId, "athleteId": athleteId },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("success");
                    console.log(textStatus);
                    console.log(data);

                    buildSegmentEffortsTable(data);
                    showActivityDetailsTable();
                });
            }

            function showDetails(event) {
                console.log("button pressed: activityId = " + event.data.activityId + ", athleteId = " + event.data.athleteId);
                getDetailedActivity(event.data.activityId, event.data.athleteId);
            }

            function buildActivityRow(activity) {

                console.log("buildActivityRow invoked, activity is ");
                console.log(activity);

                // athleteId
                athleteId = activity.athleteId;

                // id
                activityId = activity.activityId;

                // ride date
                //d = new Date(activity.start_date_local);
                d = new Date(activity.startDateTime);
                date = d.toDateString();

                // distance
//                miles = activity.distance * 0.000621371;
                miles = activity.distance;

                // riding time
                //movingTime = getMovingTime(activity.moving_time);
                movingTime = getMovingTime(activity.movingTime);

                // elevation gain
                //elevationGain = activity.total_elevation_gain * 3.28084;
                //elevationGain = Math.floor(elevationGain);
                elevationGain = activity.totalElevationGain;

                // average speed (meters per second)
                //mph = activity.average_speed * 2.23694;
                mph = activity.averageSpeed;

                calories = activity.calories;

                rowToAdd = '<tr><td>' + date + '</td><td>' + activity.name + '</td><td>' + movingTime + '</td><td>' + miles.toFixed(0) + ' miles</td><td>' + elevationGain + ' ft</td><td>' + mph.toFixed(1) + ' mph</td><td>' + calories + '</td><td>' + "<input id='" + activityId + "' type='submit' value='Show details'/>" + '</td></tr>';
                $('#myTable').append(rowToAdd);

                // add button handler for this particular activity
                btnId = "#" + activityId;
                $(btnId).click({ activityId: activityId, athleteId: athleteId }, showDetails);
            }

            function buildActivitiesTable(activities) {

                $.each(activities, function (index, activityElement) {
                    console.log("activityElement id = " + activityElement.id);
                    buildActivityRow(activityElement);
                });
            }

            function showActivitiesTable() {
                $('#SegmentEffortsFriends').hide();
                $('#DetailedActivity').hide();
                $('#SummaryActivities').show();
            }

            // get athleteId
            var athleteId = $('body').data('athleteid');
            console.log("athleteId is ");
            console.log(athleteId);

            // get summary activities for the current athlete
            $.ajax({
                url: 'http://localHost:8080/listAthleteActivities.html',
                type: 'GET',
                dataType: 'json',
                data: { "athleteId": athleteId.toString() },
                error: function () { alert('Failed!'); },
            })
            .success(function (data, textStatus, jqXHR) {
                console.log("success");
                console.log(textStatus);
                console.log(data);

                buildActivitiesTable(data);
                showActivitiesTable();
            });

        });
    </script>

    <style>
        table,th,td
        {
            border:1px solid black;
            border-collapse:collapse;
        }
        th,td
        {
            padding:5px;
        }

        #DetailedActivity {
            display: none;
        }

        #SegmentEffortsFriends {
            display: none;
        }

    </style>

</head>
<body data-athleteId="athleteIdPlaceholder">
    <p>My Strava Data</p>

    <div id="SummaryActivities">
        <table style="width:875px" id="myTable">
            <col style="width:130px">
            <col style="width:200px">
            <col style="width:100px">
            <col style="width:65px">
            <col style="width:65px">
            <col style="width:80px">
            <col style="width:80px">
            <col style="width:80px">
        <tr>
            <th>Date</th>
            <th>Name</th>
            <th>Riding Time</th>        
            <th>Distance</th>
            <th>Elevation</th>
            <th>Average Speed</th>
            <th>Calories</th>
            <th></th>
        </tr>

        </table>
    </div>

    <div id="DetailedActivity">
        <p id="activityName"></p>
        <table style="width:660px" id="DetailedActivityTable">
            <col style="width:400px">
            <col style="width:130px">
            <col style="width:130px">

            <tr>
                <th>Name</th>
                <th>Time</th>        
                <th>Distance</th>
            </tr>
        </table>
    </div>

    <div id="SegmentEffortsFriends">
        <p id="effortName"></p>
        <table style="width:680px" id="SegmentEffortsFriendsTable">
            <col style="width:400px">
            <col style="width:130px">
            <col style="width:150px">

            <tr>
                <th>Name</th>
                <th>Time</th>        
                <th>Date</th>        
            </tr>
        </table>
    </div>

</body>
</html>
