<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>StravaStatsByTed</title>

    <style>

        /*table,th,td
        {
            border:1px solid black;
            border-collapse:collapse;
        }
        th,td
        {
            padding:5px;
        }

        #DetailedActivity {
            display: none;
        }

        #SegmentEffortsFriends {
            display: none;
        }*/

      html { height: 100% } 
      body { height: 100%; margin: 0; padding: 0 }
      /*#map-canvas { height: 50% }*/
      
        #map-canvas {
            float:left;
            width:600px;
            height:800px;
            display: none;
        }
        /*#SummaryActivities {
            float:right;
            width:900px;
            height:800px;
        }*/
        #DetailedActivity {
            float:right;
            width:900px;
            height:800px;
        }
        table,th,td
        {
            border:1px solid black;
            border-collapse:collapse;
        }
        th,td
        {
            padding:5px;
        }

        #DetailedActivity {
            display: none;
        }

        #SegmentEffortsFriends {
            display: none;
        }

    </style>

    <script src="js/jquery-2.1.1.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=drawing,geometry&key=AIzaSyAQMkpxb9BOWSzHYvNhJz9LZuZqGp0toF4"></script>

    <script>
        $(document).ready(function () {
          
            var athleteId;
            var athleteName;

            var selectedActivity;

            var athletes = [];
            var segmentEffortsByAthlete = [];

            // google maps code
            function decodeLevels(encodedLevelsString) {
                var decodedLevels = [];

                for (var i = 0; i < encodedLevelsString.length; ++i) {
                    var level = encodedLevelsString.charCodeAt(i) - 63;
                    decodedLevels.push(level);
                }
                return decodedLevels;
            }


            function initializeMap(activity) {
                console.log("initializeMap: activity is");
                console.log(activity);

                console.log("type of start point latitude is " + typeof activity.startPointLatitude);

                //var myLatlng = new google.maps.LatLng(51.65905179951626, 7.3835928124999555);
                var myLatlng = new google.maps.LatLng(activity.startPointLatitude, activity.startPointLongitude);
                var myOptions = {
                    zoom: 14,
                    center: myLatlng,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

                //var decodedPath = google.maps.geometry.encoding.decodePath('}~kvHmzrr@ba\\hnc@jiu@r{Zqx~@hjp@pwEhnc@zhu@zflAbxn@fhjBvqHroaAgcnAp}gAeahAtqGkngAinc@_h|@r{Zad\\y|_D}_y@swg@ysg@}llBpoZqa{@xrw@~eBaaX}{uAero@uqGadY}nr@`dYs_NquNgbjAf{l@|yh@bfc@}nr@z}q@i|i@zgz@r{ZhjFr}gApob@ff}@laIsen@dgYhdPvbIren@');
                //var decodedPath = google.maps.geometry.encoding.decodePath("ytmcFveiiVHhAj@xDx@|GJ|AG|@Qn@SVOLgBjA{@\}@`@qA|@y@^OPMVCNCh@BfAPhACZKH]DMF]`@i@`Bc@dAOv@@h@H^@VKbCGXa@z@ANFl@P|@~@|Bj@|@n@l@Z^T`@h@rAHJPRZPvA`@xAj@z@X\N^ZFLAPGNg@\eAJ_ADc@JwAl@mAx@YVKTM|@KLKJ[Hg@Se@a@_@i@a@_@ME{BGcB?g@Dg@JkAf@m@J");

                //The problem was the backslash characters being interpreted (and removed) by javascript. So by the time the encoded string reached the DB, it no longer contained backslashes, making the polyline a completely different polyline. I tried replacing single backslashes with double backslashes: "\" -> "\", but I was having trouble with this until I did the replace over the encode function; like this:                
                //newRoutePathCoordsStr = google.maps.geometry.encoding.encodePath(newRoutePath).replace(/\\/g, "\\\\");

                //var decodedPath = google.maps.geometry.encoding.decodePath('y{ccFpuphVLj@Bj@D\Tz@NtA?|@Bl@VnA^r@XZLH`@Pl@^RHL@TGNOHOFc@@{@J_@ZaAJQLKHAj@E^IDEn@y@FEFCR?TDd@ThADNHn@Lb@@VC~@SPKb@i@Nc@HIHD|@vAp@r@\f@pAxAxAj@pGrCnA`@L@XEZOVYbBaC^s@f@uBRa@Z[j@Y\Y~CyCLGB?ADPODAXHNP|@zBf@~@Zz@Zf@V\Jb@Tb@?t@JvAC`@WpA?TH`@Xf@RVHV?bAB`@Z~A@R?J]bB@f@p@dC^fBP`@LPRHT@`@I|As@REPDDJNbAf@fBTxED|BDh@Lv@hArERdADt@E`A[tAY`AMt@C\FfACdAD|A^lEDDLBb@G^Fd@BVHHDPRXv@H\LlAF^FLPRHFPDzAE\BPFNLRZDNHp@OpE@z@GzD@VLTTDRELIb@m@Z{ABa@?k@Fm@Xw@TYHEl@Md@EJGTURGJ?f@Rd@\B?BG');

                //var pathToDecode = 'y{ccFpuphVLj@Bj@D\Tz@NtA?|@Bl@VnA^r@XZLH`@Pl@^RHL@TGNOHOFc@@{@J_@ZaAJQLKHAj@E^IDEn@y@FEFCR?TDd@ThADNHn@Lb@@VC~@SPKb@i@Nc@HIHD|@vAp@r@\f@pAxAxAj@pGrCnA`@L@XEZOVYbBaC^s@f@uBRa@Z[j@Y\Y~CyCLGB?ADPODAXHNP|@zBf@~@Zz@Zf@V\Jb@Tb@?t@JvAC`@WpA?TH`@Xf@RVHV?bAB`@Z~A@R?J]bB@f@p@dC^fBP`@LPRHT@`@I|As@REPDDJNbAf@fBTxED|BDh@Lv@hArERdADt@E`A[tAY`AMt@C\FfACdAD|A^lEDDLBb@G^Fd@BVHHDPRXv@H\LlAF^FLPRHFPDzAE\BPFNLRZDNHp@OpE@z@GzD@VLTTDRELIb@m@Z{ABa@?k@Fm@Xw@TYHEl@Md@EJGTURGJ?f@Rd@\B?BG';
                //var newPathToDecode = pathToDecode.replace(/\\/g, "\\\\");
                //var decodedPath = google.maps.geometry.encoding.decodePath(newPathToDecode);

                //var pathToDecode = 'y{ccFpuphVLj@Bj@D\\Tz@NtA?|@Bl@VnA^r@XZLH`@Pl@^RHL@TGNOHOFc@@{@J_@ZaAJQLKHAj@E^IDEn@y@FEFCR?TDd@ThADNHn@Lb@@VC~@SPKb@i@Nc@HIHD|@vAp@r@\\f@pAxAxAj@pGrCnA`@L@XEZOVYbBaC^s@f@uBRa@Z[j@Y\\Y~CyCLGB?ADPODAXHNP|@zBf@~@Zz@Zf@V\\Jb@Tb@?t@JvAC`@WpA?TH`@Xf@RVHV?bAB`@Z~A@R?J]bB@f@p@dC^fBP`@LPRHT@`@I|As@REPDDJNbAf@fBTxED|BDh@Lv@hArERdADt@E`A[tAY`AMt@C\\FfACdAD|A^lEDDLBb@G^Fd@BVHHDPRXv@H\\LlAF^FLPRHFPDzAE\\BPFNLRZDNHp@OpE@z@GzD@VLTTDRELIb@m@Z{ABa@?k@Fm@Xw@TYHEl@Md@EJGTURGJ?f@Rd@\\B?BG';
                //var decodedPath = google.maps.geometry.encoding.decodePath(pathToDecode);

                //var decodedLevels = decodeLevels("BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");
                //var decodedLevels = decodeLevels("BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");
                //var decodedLevels = decodeLevels("BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");

                var pathToDecode = activity.mapPolyline;
                var decodedPath = google.maps.geometry.encoding.decodePath(pathToDecode);
                var decodedLevels = decodeLevels("BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB");

                console.log("decodedPath is:");
                console.log(decodedPath);

                var setRegion = new google.maps.Polyline({
                    path: decodedPath,
                    levels: decodedLevels,
                    strokeColor: "#FF0000",
                    strokeOpacity: 1.0,
                    strokeWeight: 2,
                    map: map
                });









                //// Create the map.
                //var mapOptions = {
                //    zoom: 4,
                //    //zoom: zoom,
                //    center: new google.maps.LatLng(37.09024, -95.712891),
                //    //center: new google.maps.LatLng(latitude, longitude),
                //    mapTypeId: google.maps.MapTypeId.TERRAIN
                //};

                //map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
            }

            //google.maps.event.addDomListener(window, 'load', initializeMap);

            function getDistance(distanceInMeters) {
                distanceInMiles = distanceInMeters * 0.000621371;
                return distanceInMiles;
            }

            function getMovingTime(moving_time) {

                hours = Math.floor(moving_time / 3600);

                minutes = Math.floor((moving_time - 3600 * hours) / 60);
                minutesStr = minutes.toString();
                if (minutesStr.length == 1) {
                    minutesStr = "0" + minutesStr;
                }

                seconds = Math.floor(moving_time - (3600 * hours) - (60 * minutes));
                secondsStr = seconds.toString();
                if (secondsStr.length == 1) {
                    secondsStr = "0" + secondsStr;
                }

                movingTime = "";
                if (hours > 0) {
                    movingTime = hours + ':';
                }

                movingTime += minutesStr + ':' + secondsStr;
                return movingTime;
            }

            function displayFriendSegmentEffort(segmentEffort, friendName) {

                console.log("displayFriendSegmentEffort invoked");
                console.log("friend name is ");
                console.log(friendName);

                movingTime = getMovingTime(segmentEffort.moving_time);

                // ride date
                d = new Date(segmentEffort.start_date_local);
                date = d.toDateString();

                rowToAdd = '<tr><td>' + friendName + '</td><td>' + movingTime + '</td><td>' + date + '</td></tr>';
                $('#SegmentEffortsFriendsTable').append(rowToAdd);
            }

            function displaySummarySegmentEfforts(segmentName) {
                console.log('displaySummarySegmentEfforts invoked, segmentName=' + segmentName);

                $('#effortName').html("Segment is " + segmentName);

                // loop through each athlete, outputting each segment effort for the given athlete
                $.each(segmentEffortsByAthlete, function (index, friendEfforts) {
                    friendName = friendEfforts.athleteName;
                    $.each(friendEfforts.segmentEffort, function (index, friendEffort) {
                        displayFriendSegmentEffort(friendEffort, friendName);
                    });
                });
            }

            function getSummarySegmentEfforts(segmentId, segmentName) {
                console.log('getSummarySegmentEfforts invoked:' + segmentId + ' ' + segmentName);

                // get the id of the next athlete
                if (Object.keys(athletes).length == 0) {
                    displaySummarySegmentEfforts(segmentName);
                    return;
                }

                for (var friendId in athletes) {
                    athleteName = athletes[friendId];  // get an item
                    delete athletes[friendId];           // delete from aa
                    break;
                }

                console.log('athlete id, name:');
                console.log(friendId);
                console.log(athleteName);

                //console.log("was athletes shrunk?");
                //console.log(athletes);

                // get summary activities for the specified athlete
                $.ajax({
                    url: 'http://localHost:8080/allEfforts',
                    data: { "segment_id": segmentId.toString(), "athlete_id": athleteId, "friend_id": friendId.toString() },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("allEfforts success");
                    console.log(textStatus);
                    console.log(data);

                    summarySegmentEffort = {};
                    summarySegmentEffort.athleteId = friendId;
                    summarySegmentEffort.athleteName = athleteName;
                    summarySegmentEffort.segmentEffort = data;
                    segmentEffortsByAthlete.push(summarySegmentEffort);

                    getSummarySegmentEfforts(segmentId, segmentName);
                });
            }

            function showFriendsResults(event) {

                console.log("athleteId is " + athleteId);

                console.log("button pressed: id = " + event.data.id.toString());
                console.log(event.data.name);

                // get friends for the authenticated athlete
                $.ajax({
                    url: 'http://localHost:8080/friends',
                    data: { "athleteId": athleteId.toString() },
                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("friends success");
                    console.log(textStatus);
                    console.log(data);

                    athletes = {};

                    // data has the list of athletes
                    $.each(data, function (index, friend) {
                        athletes[friend.id] = friend.firstname + " " + friend.lastname;
                    });

                    // add authenticated athlete to the list
                    athletes[athleteId] = athleteName;

                    segmentEffortsByAthlete = [];

                    getSummarySegmentEfforts(event.data.id, event.data.name);

                    $('#DetailedActivity').hide();         // show the segment efforts table
                    $('#SegmentEffortsFriends').show();    // show the friends segment efforts table

                });
            }

            function buildSegmentEffortsRow(detailedEffort) {

                segmentId = detailedEffort.segmentId;
                segmentEffortId = detailedEffort.segmentEffortId;

                // name
                name = detailedEffort.segmentEffortName;

                // time
                movingTime = getMovingTime(detailedEffort.movingTime);

                // distance
                distanceInMiles = detailedEffort.segmentEffortDistance;

                // start date/time
                d = new Date(detailedEffort.startDateTime);
                //startDateTime = d.toDateString();
                startDateTime = d.toLocaleString();

                // average grade
                averageGrade = detailedEffort.averageGrade;

                // elevation gain
                elevationGain = detailedEffort.totalElevationGain;

                rowToAdd = '<tr><td>' + name + '</td><td>' + movingTime + '</td><td>' + distanceInMiles.toFixed(1) + '</td><td>' + startDateTime + '</td><td>' + averageGrade + '%</td><td>' + elevationGain.toFixed(0) + ' feet</td><td>' + "<input id='" + segmentId.toString() + "' type='submit' value='Show friends'/>" + '</td></tr>';
                $('#DetailedActivityTable').append(rowToAdd);

                // add button handler to show friends' result for this segment
                btnId = "#" + segmentId.toString();
                $(btnId).click({ id: segmentId.toString(), name: name }, showFriendsResults);

            }

            function buildSegmentEffortsTable(activity) {
                $('#activityName').html("Ride name is " + activity.name);

                detailedEfforts = activity.detailedEfforts;
                $.each(detailedEfforts, function (index, detailedEffort) {
                    buildSegmentEffortsRow(detailedEffort);
                });
            }

            function showActivityDetails(event) {
                $('#SummaryActivities').hide();
                $('#DetailedActivity').show();
                $('#map-canvas').show();
            }

            function getActivityEfforts(activityId, athleteId, activityName) {
                // get detailed activity data for the current athlete
                $.ajax({
                    url: 'http://localHost:8080/activityEfforts',
                    data: { "activityId": activityId, "athleteId": athleteId, "activityName": activityName },

                    type: 'GET',
                    dataType: 'json',
                    error: function () { alert('Failed!'); },
                })
                .success(function (data, textStatus, jqXHR) {
                    console.log("success");
                    console.log(textStatus);
                    console.log(data);

                    buildSegmentEffortsTable(data);

                    initializeMap(selectedActivity);

                    showActivityDetails();
                });
            }

            function showDetails(event) {
                console.log("button pressed: activityId = " + event.data.activityId + ", athleteId = " + event.data.athleteId);

                selectedActivity = event.data.activity;

                getActivityEfforts(event.data.activityId, event.data.athleteId, event.data.activityName);
            }

            function buildActivityRow(activity) {

                console.log("buildActivityRow invoked, activity is ");
                console.log(activity);

                // activityName
                activityName = activity.name;

                // athleteId
                athleteId = activity.athleteId;

                // id
                activityId = activity.activityId;

                // ride date
                //d = new Date(activity.start_date_local);
                d = new Date(activity.startDateTime);
                date = d.toLocaleString();

                // distance
                miles = activity.distance;

                // riding time
                movingTime = getMovingTime(activity.movingTime);

                // elevation gain
                elevationGain = activity.totalElevationGain;

                // average speed (meters per second)
                mph = activity.averageSpeed;

                calories = activity.calories;

                rowToAdd = '<tr><td>' + date + '</td><td>' + activity.name + '</td><td>' + movingTime + '</td><td>' + miles.toFixed(0) + ' miles</td><td>' + elevationGain + ' ft</td><td>' + mph.toFixed(1) + ' mph</td><td>' + calories + '</td><td>' + "<input id='" + activityId + "' type='submit' value='Show details'/>" + '</td></tr>';
                $('#myTable').append(rowToAdd);

                // add button handler for this particular activity
                btnId = "#" + activityId;
                $(btnId).click({ activityId: activityId, athleteId: athleteId, activityName: activityName, activity: activity }, showDetails);
            }

            function buildActivitiesTable(activities) {

                $.each(activities, function (index, activityElement) {
                    console.log("activityElement id = " + activityElement.id);
                    buildActivityRow(activityElement);
                });
            }

            function sortActivitiesByDate(activities) {
                $.each(activities, function (index, activity) {
                    activity.dateTime = new Date(activity.startDateTime);
                    console.log("type of startDateTime is " + typeof activity.startDateTime);
                    console.log("type of dateTime is " + typeof activity.dateTime);
                });

                activities.sort(function (a, b) {
                    if (a.dateTime < b.dateTime)
                        return 1;
                    if (a.dateTime > b.dateTime)
                        return -1
                    return 0;
                });
            }

            function showActivitiesTable() {
                $('#SegmentEffortsFriends').hide();
                $('#DetailedActivity').hide();
                $('#SummaryActivities').show();
            }

            // get athleteId
            athleteId = $('body').data('athleteid');
            console.log("athleteId is ");
            console.log(athleteId);
            athleteName = $('body').data('athletename');
            console.log("athleteName is ");
            console.log(athleteName);

            // get summary activities for the current athlete
            $.ajax({
                url: 'http://localHost:8080/athleteActivities',
                type: 'GET',
                dataType: 'json',
                data: { "athleteId": athleteId.toString() },
                error: function () { alert('Failed!'); },
            })
            .success(function (data, textStatus, jqXHR) {
                console.log("success");
                console.log(textStatus);
                console.log(data);

                sortActivitiesByDate(data);

                buildActivitiesTable(data);
                showActivitiesTable();
            });

        });
    </script>

<!--    <style>
        table,th,td
        {
            border:1px solid black;
            border-collapse:collapse;
        }
        th,td
        {
            padding:5px;
        }

        #DetailedActivity {
            display: none;
        }

        #SegmentEffortsFriends {
            display: none;
        }

    </style>-->

</head>
<body data-athleteId="athleteIdPlaceholder", data-athleteName="athleteNamePlaceholder">
    <p>My Strava Data</p>

    <div class="background" style="position: relative; width:1900px; height:900px;">

        <p>More Strava Data</p>

        <div id="SummaryActivities">
        <table style="width:875px" id="myTable">
            <col style="width:130px">
            <col style="width:200px">
            <col style="width:100px">
            <col style="width:65px">
            <col style="width:65px">
            <col style="width:80px">
            <col style="width:80px">
            <col style="width:80px">
        <tr>
            <th>Date</th>
            <th>Name</th>
            <th>Riding Time</th>        
            <th>Distance</th>
            <th>Elevation</th>
            <th>Average Speed</th>
            <th>Calories</th>
            <th></th>
        </tr>

        </table>
    </div>

    <div id="DetailedActivity">
        <p id="activityName"></p>
        <table style="width:790px" id="DetailedActivityTable">
            <col style="width:400px">
            <col style="width:130px">
            <col style="width:130px">
            <col style="width:260px">
            <col style="width:130px">
            <col style="width:130px">

            <tr>
                <th>Name</th>
                <th>Time</th>        
                <th>Distance</th>
                <th>Start Date/Time</th>
                <th>Average Grade</th>
                <th>Elevation Gain</th>
            </tr>
        </table>
    </div>

        <div id="map-canvas"</div>


    <div id="SegmentEffortsFriends">
        <p id="effortName"></p>
        <table style="width:680px" id="SegmentEffortsFriendsTable">
            <col style="width:400px">
            <col style="width:130px">
            <col style="width:150px">

            <tr>
                <th>Name</th>
                <th>Time</th>        
                <th>Date</th>        
            </tr>
        </table>
    </div>
    </div>
</body>
</html>
